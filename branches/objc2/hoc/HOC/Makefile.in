include ../config.mk

dist_srcdir = HOC
dist_FILES = \
	HOC \
	HOC-gnustep.conf \
	HOC-gnustep.conf-inplace \
	HOC-macos.conf \
	HOC-macos.conf-inplace \
	HOC.hs \
	Makefile.in \
	$(NULL)

ifeq "$(HocBuildDylibs)" "YES"
LIBRARIES=libHOC.a libHOC.dylib
else
LIBRARIES=libHOC.a HOC.o
endif

FOUND_SOURCES := $(shell find . -name '*.hs')

HOCLIBDIR="$(destdir)"/$(GHC_LIB_PATH)/HOC

all: $(LIBRARIES) ../inplace.conf

../inplace.conf: HOC.conf-inplace
	[ -f "$@" ] || echo '[]' > $@
	$(GHC_PKG) update HOC.conf-inplace \
		--package-conf=../inplace.conf

%.conf: %.conf.in
	gcc -E -x c -DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
			-DFFI_LIB_DIRS=@FFI_LIB_DIRS@ \
			-DPKG_EXTRA_LIBS=@PKG_EXTRA_LIBS@ \
		@HOC_DEFINES@ $< | grep -v '^#' > $@ 
%.conf-inplace: %.conf.in
	gcc -E -x c -DINPLACE=1 \
		-DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
			-DFFI_LIB_DIRS=@FFI_LIB_DIRS@ \
			-DPKG_EXTRA_LIBS=@PKG_EXTRA_LIBS@ \
		@HOC_DEFINES@ $< | grep -v '^#' > $@ 

libHOC.a: ghcmake.build-stamp
	find build/objects/ -name \*.o | xargs $(MAKE_STATIC_LIB) libHOC.a

libHOC.dylib: ghcmake.build-stamp
	find build/objects/ -name \*.o \
	 | xargs libtool \
	   -dynamic \
	   $(FFI_LIBS) \
	   -undefined dynamic_lookup \
	   -single_module \
	   -o $@
	install_name_tool -id "`pwd`/$@" $@

HOC.o: libHOC.a
	ld -r -x -o HOC.o $(FFI_LIBS) $(ALL_LOAD) libHOC.a

ghcmake: ghcmake.build-stamp

ifeq "$(HocBuildDylibs)" "YES"
CBITS=-L../HOC_cbits -lHOC_cbits
else
CBITS=../HOC_cbits/HOC_cbits.o
endif

ghcmake.build-stamp: $(FOUND_SOURCES)
	mkdir -p build/objects
	mkdir -p build/imports
	$(GHC) --make HOC.hs \
		-O -fasm \
		-fPIC \
		-odir build/objects -hidir build/imports	\
		-fglasgow-exts -fth \
		-lobjc      \
		$(CBITS)	\
		-I../HOC_cbits	\
		$(FFI_CFLAGS)	\
		$(FFI_LIBS)     \
		-package-name HOC \
		-package unix \
		$(FOUNDATION_INCLUDES) \
		$(FOUNDATION_LIBS)      \
		$(DEFINES)  \
		$(EXTRA_GHCFLAGS)
	touch $@

clean:
	rm -rf libHOC.a HOC.o build \
	    HOC/NewClass_stub.c HOC/NewClass_stub.h \
	    ghcmake.build-stamp

install: install-files
	ranlib $(HOCLIBDIR)/libHOC.a
ifeq "$(HocBuildDylibs)" "YES"
	install_name_tool -id $(HOCLIBDIR)/libHOC.dylib $(HOCLIBDIR)/libHOC.dylib
endif
	$(GHC_PKG) update HOC.conf
       
install-files: all HOC.conf
	mkdir -p $(HOCLIBDIR)
	cp -R $(LIBRARIES) build/imports \
		$(HOCLIBDIR)
