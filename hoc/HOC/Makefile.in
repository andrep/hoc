include ../config.mk

dist_srcdir = HOC
dist_FILES = \
	HOC \
	HOC-gnustep.conf \
	HOC-gnustep.conf-inplace \
	HOC-macos.conf \
	HOC-macos.conf-inplace \
	HOC.hs \
	Makefile.in \
	$(NULL)

ifeq "$(HocBuildDylibs)" "YES"
LIBRARIES=libHOC.a libHOC_dyn.dylib
else
LIBRARIES=libHOC.a HOC.o
endif

HOCLIBDIR="$(destdir)"/$(GHC_LIB_PATH)/HOC

all: $(LIBRARIES) ../inplace.conf

../inplace.conf: HOC.conf-inplace
	[ -f "$@" ] || echo '[]' > $@
	$(GHC_PKG) update HOC.conf-inplace \
		--package-conf=../inplace.conf

%.conf: %.conf.in
	gcc -E -x c -DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
		@HOC_DEFINES@ $< | grep -v '^#' > $@ 
%.conf-inplace: %.conf.in
	gcc -E -x c -DINPLACE=1 \
		-DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
		@HOC_DEFINES@ $< | grep -v '^#' > $@ 

libHOC.a: ghcmake.build-stamp
	find build/objects/ -name \*.o | xargs $(MAKE_STATIC_LIB) libHOC.a

libHOC_dyn.dylib: ghcmake.build-stamp
	export MACOSX_DEPLOYMENT_TARGET=10.3 && find build/objects/ -name \*.o \
	 | xargs libtool \
	   -dynamic \
	   -undefined dynamic_lookup \
	   -single_module \
	   -o $@
	install_name_tool -id "`pwd`/$@" $@

HOC.o: libHOC.a
	ld_classic -r -x -o HOC.o $(ALL_LOAD) libHOC.a

ghcmake: ghcmake.build-stamp

ifeq "$(HocBuildDylibs)" "YES"
CBITS=-L../HOC_cbits -lHOC_cbits_dyn
else
CBITS=../HOC_cbits/HOC_cbits.o
endif

ghcmake.build-stamp:
	mkdir -p build/objects
	mkdir -p build/imports
	$(GHC) --make HOC.hs	\
		-O -fasm \
		-odir build/objects -hidir build/imports	\
		-fglasgow-exts -fth \
        -lobjc      \
		$(CBITS)	\
		-I../HOC_cbits	\
		-I../libffi-src/build/include	\
		-package-name HOC \
		-package unix \
		$(FOUNDATION_INCLUDES) \
		$(FOUNDATION_LIBS)      \
                $(DEFINES)  \
		$(EXTRA_GHCFLAGS)
	touch $@

clean:
	rm -rf libHOC.a HOC.o build \
	    HOC/NewClass_stub.c HOC/NewClass_stub.h \
	    ghcmake.build-stamp

install: install-files
	ranlib $(HOCLIBDIR)/libHOC.a
ifeq "$(HocBuildDylibs)" "YES"
	install_name_tool -id $(HOCLIBDIR)/libHOC_dyn.dylib $(HOCLIBDIR)/libHOC_dyn.dylib
endif
	$(GHC_PKG) update HOC.conf
       
install-files: all HOC.conf
	mkdir -p $(HOCLIBDIR)
	cp -R $(LIBRARIES) build/imports \
		$(HOCLIBDIR)
