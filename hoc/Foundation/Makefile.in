include ../config.mk

dist_srcdir = Foundation
dist_FILES = \
	Foundation.conf \
	Foundation.conf-inplace \
	Makefile.in \
	$(NULL)

ifeq "$(HocBuildDylibs)" "YES"
LIBRARIES=libHSFoundation.a libHSFoundation_dyn.dylib
else
LIBRARIES=libHSFoundation.a HSFoundation.o
endif

FOUNDATIONLIBDIR="$(destdir)"/$(GHC_LIB_PATH)/Foundation

all: $(LIBRARIES) register-inplace.build-stamp

register-inplace.build-stamp: Foundation.conf-inplace
	[ -f "../inplace.conf" ] || echo '[]' > ../inplace.conf
	$(GHC_PKG) update Foundation.conf-inplace \
		--package-conf=../inplace.conf
	touch $@

exposed-modules.txt:
	find build/imports | grep '\.hi' \
            | sed 's@build/imports/@ @g' | sed 's/\.hi//g' | sed 's@/@.@g' \
            > exposed-modules.txt

Foundation.conf-inplace: Foundation.conf.in exposed-modules.txt
	gcc -E -x c -DINPLACE=1 \
		-DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
		@HOC_DEFINES@ Foundation.conf.in | grep -v '^#' > Foundation.conf-inplace 
	cat exposed-modules.txt >> Foundation.conf-inplace

Foundation.conf: Foundation.conf.in exposed-modules.txt
	gcc -E -x c -DGHC_LIB_PATH=@GHC_LIB_PATH@ \
        	-DFOUNDATION_LIB_DIRS=@HOC_FOUNDATION_LIB_DIRS@ \
		@HOC_DEFINES@ Foundation.conf.in | grep -v '^#' > $@ 
	cat exposed-modules.txt >> Foundation.conf

ghcmake.build-stamp:
	ln -sf ../Bindings/ifgen-output/Foundation.hs .
	ln -sf ../Bindings/ifgen-output/Foundation .
	test ! -d ../Bindings/ifgen-output/GNUstepBase || \
		ln -sf ../Bindings/ifgen-output/GNUstepBase .
	test ! -r ../Bindings/ifgen-output/GNUstepBase.hs || \
		ln -sf ../Bindings/ifgen-output/GNUstepBase.hs .
	mkdir -p build/objects
	mkdir -p build/imports
	$(GHC) --make Foundation.hs	\
		-O -fasm \
		-odir build/objects \
		-package-name Foundation \
		-hidir build/imports	\
		-package-conf ../inplace.conf \
		-fglasgow-exts -fth\
		-package unix \
		$(EXTRA_GHCFLAGS)
                
	test ! -r GNUstepBase.hs || \
		$(GHC) --make GNUstepBase.hs	\
			-package-name Foundation	\
			-odir build/objects \
			-hidir build/imports	\
			-package-conf ../inplace.conf \
			-fglasgow-exts -fth \
			$(EXTRA_GHCFLAGS)
	touch $@

HSFoundation.o: ghcmake.build-stamp
	find build/objects/ -name \*.o | xargs ld -r -x -o HSFoundation.o

libHSFoundation.a: ghcmake.build-stamp
	find build/objects/ -name \*.o | xargs $(MAKE_STATIC_LIB) libHSFoundation.a	

libHSFoundation_dyn.dylib: ghcmake.build-stamp
	export MACOSX_DEPLOYMENT_TARGET=10.3 && find build/objects/ -name \*.o \
	 | xargs libtool -dynamic -o $@ -undefined dynamic_lookup -single_module
	install_name_tool -id "`pwd`/$@" $@

clean:
	rm -rf build libHSFoundation.a libHSFoundation_dyn.dylib \
	    HSFoundation.o Foundation.hs Foundation ghcmake.build-stamp \
	    exposed-modules.txt Foundation.conf Foundation.conf-inplace \
	    register-inplace.build-stamp
	
install: install-files
	ranlib $(FOUNDATIONLIBDIR)/libHSFoundation.a
ifeq "$(HocBuildDylibs)" "YES"
	install_name_tool -id $(FOUNDATIONLIBDIR)/libHSFoundation_dyn.dylib \
	   $(FOUNDATIONLIBDIR)/libHSFoundation_dyn.dylib
endif
	$(GHC_PKG) update Foundation.conf
	
install-files: all Foundation.conf
	mkdir -p $(FOUNDATIONLIBDIR)
	cp -R $(LIBRARIES) \
	 build/imports $(FOUNDATIONLIBDIR)

